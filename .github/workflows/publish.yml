name: Publish Packages

on:
  workflow_run:
    workflows: ["Continuous Integration"]
    types:
      - completed
    branches:
      - main

jobs:
  publish:
    runs-on: ubuntu-latest
    # Only run if CI workflow succeeded
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    permissions:
      contents: read
      id-token: write # Required for npm provenance

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2 # Fetch current and previous commit to detect changes

      - name: Check for package.json changes
        id: check_changes
        run: |
          # Check if any package.json files changed in the last commit
          if git diff --name-only HEAD~1 HEAD | grep -q 'packages/.*/package.json'; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "âœ… Package.json files changed, proceeding with publish checks"
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "â­ï¸  No package.json changes detected, skipping publish"
          fi

      - name: Use Node.js
        if: steps.check_changes.outputs.changed == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: 22.x
          registry-url: "https://registry.npmjs.org"

      - name: Use pnpm
        if: steps.check_changes.outputs.changed == 'true'
        uses: pnpm/action-setup@v4
        with:
          run_install: true

      - name: Detect version changes
        if: steps.check_changes.outputs.changed == 'true'
        id: detect
        run: |
          # Function to check if package version changed
          check_version_change() {
            local package_path=$1
            local package_name=$2

            # Get current version
            current_version=$(node -p "require('./${package_path}/package.json').version")

            # Get previous version (from previous commit)
            previous_version=$(git show HEAD~1:./${package_path}/package.json | node -p "JSON.parse(require('fs').readFileSync(0, 'utf-8')).version")

            if [ "$current_version" != "$previous_version" ]; then
              echo "ðŸ“¦ ${package_name}: ${previous_version} â†’ ${current_version}"
              echo "${package_name}=true" >> $GITHUB_OUTPUT
            else
              echo "â­ï¸  ${package_name}: ${current_version} (no change)"
              echo "${package_name}=false" >> $GITHUB_OUTPUT
            fi
          }

          echo "Checking for version changes..."
          check_version_change "packages/utils" "utils"
          check_version_change "packages/transport" "transport"
          check_version_change "packages/engine" "engine"

      - name: Build all packages
        if: steps.check_changes.outputs.changed == 'true' && (steps.detect.outputs.utils == 'true' || steps.detect.outputs.transport == 'true' || steps.detect.outputs.engine == 'true')
        run: pnpm build:packages

      - name: Publish @blibliki/utils
        if: steps.check_changes.outputs.changed == 'true' && steps.detect.outputs.utils == 'true'
        working-directory: ./packages/utils
        run: |
          echo "Publishing @blibliki/utils..."
          pnpm publish --access public --no-git-checks
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Publish @blibliki/transport
        if: steps.check_changes.outputs.changed == 'true' && steps.detect.outputs.transport == 'true'
        working-directory: ./packages/transport
        run: |
          echo "Publishing @blibliki/transport..."
          pnpm publish --access public --no-git-checks
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Publish @blibliki/engine
        if: steps.check_changes.outputs.changed == 'true' && steps.detect.outputs.engine == 'true'
        working-directory: ./packages/engine
        run: |
          echo "Publishing @blibliki/engine..."
          pnpm publish --access public --no-git-checks
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Summary
        if: steps.check_changes.outputs.changed == 'true' && (steps.detect.outputs.utils == 'true' || steps.detect.outputs.transport == 'true' || steps.detect.outputs.engine == 'true')
        run: |
          echo "### ðŸ“¦ Published Packages" >> $GITHUB_STEP_SUMMARY
          [ "${{ steps.detect.outputs.utils }}" == "true" ] && echo "- âœ… @blibliki/utils" >> $GITHUB_STEP_SUMMARY || true
          [ "${{ steps.detect.outputs.transport }}" == "true" ] && echo "- âœ… @blibliki/transport" >> $GITHUB_STEP_SUMMARY || true
          [ "${{ steps.detect.outputs.engine }}" == "true" ] && echo "- âœ… @blibliki/engine" >> $GITHUB_STEP_SUMMARY || true
